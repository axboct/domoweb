<style>
@font-face {
  font-family: 'FontAwesome';
  src: url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.eot?v=4.7.0');
  src: url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.eot?#iefix&v=4.7.0') format('embedded-opentype'), url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.woff2?v=4.7.0') format('woff2'), url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.woff?v=4.7.0') format('woff'), url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.ttf?v=4.7.0') format('truetype'), url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.svg?v=4.7.0#fontawesomeregular') format('svg');
  font-weight: normal;
  font-style: normal;
}
</style>

<polymer-element name="dmw-highcharts-sensorNumberChart" extends="dmw-widget">
    <template>
        <link rel="stylesheet" href="/widget/basic/css/common.css" shim-domshadow>
        <link rel="stylesheet" href="/widget/basic/font-awesome-4.7.0/css/font-awesome.min.css" shim-domshadow>
        <style type="text/css">
            :host {
                height: 100%;
                display: block;
            }
            #number {
                position: relative;
                top: 50%;
                -webkit-transform: translate(-50%, -50%);
                -ms-transform: translate(-50%, -50%);
                transform: translate(-50%, -50%);
                left: 50%;
                text-align: center;
                overflow: hidden;
                display: inline-block;
                padding: 10px;
            }
            #unit {
                position: absolute;
                top:5px;
                right: 5px;
                font-size: 1em;
            }
            #icongraph {
                position: absolute;
                bottom: 5px;
                right: 5px;
                font-size: 1em;
            }
            #icongraphlink {
                text-decoration: none;
                color: inherit;
            }
            #graph {
                display: none;
                position: absolute;
                top: 10px;
                left: 10px;
                width: 600px;
                min-height: 400px;
                background-color: rgba(50, 50, 50, 0.5);
                border: 6px solid rgba(50, 50, 50, 0.5) ;
                margin: auto;              
                z-index: 10;
            }          
        </style>
        
        <dmw-sensor id='primary' sensorkey="primary" sensorvalue="{{sensorvalue}}" sensorhistory="{{history}}"></dmw-sensor>
        
        <shadow></shadow>
        
        <div id='number'>{{number}}</div>
        <div id='unit'>{{unit}}</div>
        
        <div id="icongraph" on-click="{{displayGraph}}">
            <a id="icongraphlink" href="#"><i class="fa fa-area-chart"></i></a>
        </div>
        <div id="graph" on-dblclick="{{hideGraph}}"><i class="fa fa-spinner fa-pulse"></i>  Loading Graph ...</div>

        
    </template>

    <script src="/widget/highcharts/Highstock-5.0.14/code/highstock.js"></script>
    <script src="/widget/highcharts/Highstock-5.0.14/code/modules/exporting.js"></script>
    <!-- <script src="/widget/highcharts/Highstock-5.0.14/code/js/themes/sunset.js"></script> -->
    <!-- avocado.js dark-blue.js dark-green.js dark-unica.js gray.js grid-light.js grid.js sand-signika.js skies.js sunset.js -->
    
    <script>    
        Polymer('dmw-highcharts-sensorNumberChart', {
            // ------------------------------------------------------------------------------------
            ready: function() {
                this.number = "--";
                this.unit = "";
                this.super();
                
                Highcharts.setOptions({
                    global: { 
                        useUTC: false 
                    }  
                });
                
                this.periode = "day" ;
                initialZIndex = this.style.zIndex;      // z-index for the zoom mode
            },

            // ------------------------------------------------------------------------------------
            optionsUpdated: function() {
                if (this.options['hideLabels'] == true ) {         
                    this.$.labelprimary.style.visibility = "hidden";
                    this.$.labelsecondary.style.visibility = "hidden";
                }
                else {
                    this.$.labelprimary.style.visibility = "visible";
                    this.$.labelsecondary.style.visibility = "visible";
                }
                this.color = this.options['color'] ;
                console.error("theme: " + this.options['theme']) ;
            },
            
            // ------------------------------------------------------------------------------------
            sensorsUpdated: function() {
                if (this.$.primary.isSet) {
                    this.labelprimary = this.$.primary.device['name'] ;
                    this.labelsecondary = this.$.primary.name;
                }
            },
            
            // ------------------------------------------------------------------------------------
            sensorvalueChanged: function(oldValue, newValue) {
                newValue = newValue.stored_value;
                var unit = this.datatypes[this.$.primary.datatype_id]['unit'];
                if (this.options['autoconvert']==1 && newValue > 0) {
                       var k = 1000;
                       var sizes = ['', 'K', 'M', 'G', 'T', 'P', 'E', 'Z', 'Y'];
                       var i = Math.floor(Math.log(newValue) / Math.log(k));
                    this.$.number.innerHTML = (newValue / Math.pow(k, i)).toPrecision(3);
                    if (unit) {
                        this.unit = sizes[i] + i18n.t("domoweb:unit", { context: this.$.primary.datatype_id, value: unit });
                    }
                } else {
                    this.$.number.innerHTML = newValue;
                    if (unit) {
                        this.unit = i18n.t("domoweb:unit", { context: this.$.primary.datatype_id, value: unit });
                    }
                }
                this.adjustText(this, this.$.number);
            },

            // ------------------------------------------------------------------------------------
            adjustText: function(parent, element) {
                var fontsize = window.getComputedStyle(element,null).getPropertyValue("font-size");
                var i = fontsize.substr(0,2);
                // in case the page is not yet nicely loaded...
                if (parent.clientWidth == 0 || parent.clientHeight == 0) {
                    setTimeout(function(){
                        this.adjustText(parent, element);
                        }.bind(this), 1000);
                }
                else {
                    if (parent.clientWidth > element.clientWidth && parent.clientHeight > element.clientHeight) {
                        while ( parent.clientWidth > element.clientWidth && parent.clientHeight > element.clientHeight && i < 100){
                            element.style.fontSize = i+"px";
                            i++;
                        }
                    } else if (parent.clientWidth < element.clientWidth || parent.clientHeight < element.clientHeight) { // If text is bigger than widget
                        while (parent.clientWidth < element.clientWidth || parent.clientHeight < element.clientHeight){
                            element.style.fontSize = i+"px";
                            i--;
                        }
                    }
                }
            },

            // ------------------------------------------------------------------------------------
            historyChanged: function(oldValue, newValue) { 
                //console.error("historyChanged: " + newValue);
                /* historyChanged: 
                 Day:
                 2017,10,42,18,20,55,15.7,
                 2017,10,42,18,20,56,15.7,
                 2017,10,42,18,20,57,15.6,
                 ...
                 2017,10,42,18,21,45,14.55
                 
                 Week:
                 2017,10,42,18,20,15.666666666666666,
                 2017,10,42,18,21,14.973076923076926,
                 2017,10,42,18,22,14.237499999999999
                 ...
                 2017,10,42,19,10,16.173333333333336
                 
                 Month per days:
                 2017,10,42,18,14.454098360655738,
                 2017,10,42,19,15.720973154362433,
                 2017,10,42,20,14.859459459459458
                 
                 Month per hours:
                 2017,10,42,18,20,15.666666666666666,
                 2017,10,42,18,21,14.973076923076926,
                 2017,10,42,18,22,14.237499999999999,
                 ...
                 2017,10,42,19,3,12.669696969696968
                */
                this.data = [] ;
                for (i = 0; i < newValue.length; i++) {
                    value = [] ;
                    
                    switch(this.periode) {
                        case "day":         //  year            month           day             hour            minute        s  ms
                            var dt = new Date(newValue[i][0], newValue[i][1] - 1, newValue[i][3], newValue[i][4], newValue[i][5], 0, 0) ;
                            value[1] = newValue[i][6] ;
                            break;
                        case "week":
                        case "month":   // Month Per hours
                            var dt = new Date(newValue[i][0], newValue[i][1] - 1, newValue[i][3], newValue[i][4], 0, 0, 0) ;  
                            value[1] = newValue[i][5] ;
                            break;
                        /*case "month":
                            var dt = new Date(newValue[i][0], newValue[i][1] - 1, newValue[i][3], 0, 0, 0, 0) ;
                            value[1] = newValue[i][4] ;
                            break;*/
                    }

                    value[0] = dt.getTime() ;   // Timestamp Unix (ms)
                    this.data.push(value)
                }
                //console.error("==> " + this.data) ;

                var self = this;                                // Important for rangeSelector buttons event !
                $(this.$.graph).highcharts('StockChart', {
                    rangeSelector: {
                        buttons: [{
                            type: '',
                            count: 1,
                            text: 'Day'
                          },{
                            type: '',
                            count: 1,
                            text: 'Week'
                          },{
                            type: '',
                            count: 1,
                            text: 'Month'
                          }],
                        inputEnabled: false
                    },
                    title: {
                        text: this.$.primary.device['name']
                    },
                    subtitle: {
                        text: '<i>(Current ' + this.periode + ')</i>'
                    },                        
                    xAxis: {
                        gridLineWidth: 1,
                        events: {
                            setExtremes: function(e) {
                                if(typeof(e.rangeSelectorButton) !== 'undefined')
                                {
                                    console.error("Button " + e.rangeSelectorButton.text + " pressed");
                                    self.periode = e.rangeSelectorButton.text.toLowerCase();
                                    switch(self.periode) {
                                        case "day":
                                            self.$.primary.getCurrentDay() ;        // 'interval': 'minute'
                                            break;
                                        case "week":
                                            self.$.primary.getCurrentWeek() ;       // 'interval': 'hour'         
                                            break;
                                        case "month":
                                            //self.$.primary.getCurrentMonth() ;      // 'interval': 'day'       
                                            self.$.primary.getCurrentMonthPerHour() ; // 'interval': 'hour'
                                            break;
                                    } 
                                }
                            }
                        }
                    },
                    yAxis: {
                        title: {
                            text: this.$.primary.name
                        },
                        opposite: false,
                    },
                    legend: {
                        enabled: true
                    },
                    series: [{
                        name: this.$.primary.name,
                        type: 'line',
                        data: this.data,
                        color: this.color,
                        lineWidth: 1,
                        tooltip: {
                            valueDecimals: 1,
                            valueSuffix: this.unit
                        }
                    }]
                }); 
                
            },
            
            // ------------------------------------------------------------------------------------
            displayGraph: function() {
                this.$.graph.style.display = "block";
                //this.$.graph.style.zIndex = 5000;
                this.style.zIndex = 5000;
                this.$.primary.getCurrentDay() ;        // 'interval': 'minute'
                this.periode = "day" ;
            },
            
            // ------------------------------------------------------------------------------------
            hideGraph: function() {
                this.$.graph.style.display = "none";
                //this.$.graph.style.zIndex = 10;
                this.style.zIndex = initialZIndex;
            },
        });
        
    </script>
</polymer-element>
