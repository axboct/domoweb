<style>
@font-face {
  font-family: 'FontAwesome';
  src: url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.eot?v=4.7.0');
  src: url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.eot?#iefix&v=4.7.0') format('embedded-opentype'), url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.woff2?v=4.7.0') format('woff2'), url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.woff?v=4.7.0') format('woff'), url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.ttf?v=4.7.0') format('truetype'), url('/widget/basic/font-awesome-4.7.0/fonts//fontawesome-webfont.svg?v=4.7.0#fontawesomeregular') format('svg');
  font-weight: normal;
  font-style: normal;
}
</style>

<script src="/widget/highcharts/Highstock-5.0.14/code/highstock.js"></script>
<script src="/widget/highcharts/Highstock-5.0.14/code/modules/exporting.js"></script>
<!-- <script src="/widget/highcharts/Highstock-5.0.14/code/js/themes/sunset.js"></script> -->
<!-- avocado.js dark-blue.js dark-green.js dark-unica.js gray.js grid-light.js grid.js sand-signika.js skies.js sunset.js -->

<polymer-element name="dmw-highcharts-sensorBoolChart" extends="dmw-widget">
    <template>
        <link rel="stylesheet" href="/widget/basic/css/common.css" shim-domshadow>
        <link rel="stylesheet" href="/widget/basic/font-awesome-4.7.0/css/font-awesome.min.css" shim-domshadow>
        <style type="text/css">
            :host {
                height: 100%;
            }
            #bool {
                position: relative;
                top: 50%;
                -webkit-transform: translateY(-50%);
                -ms-transform: translateY(-50%);
                transform: translateY(-50%);
                  text-align: center;
                font-size: 2em;
                white-space: normal;
            }
            .glyphicon {
                line-height: inherit;
            }
            #bool.true {
                color: #5cb85c;
            }
            #bool.false {
                color: #d9534f;
            }
            
            #icongraph {
                position: absolute;
                bottom: 2px;
                right: 5px;
                font-size: 1em;
            }
            #icongraphlink {
                text-decoration: none;
                color: inherit;
            }
            #graph {
                display: none;
                position: fixed;
                top: 10px;
                left: 10px;
                width: 750px;
                height: 440px;
                background-color: rgba(50, 50, 50, 0.5);
                border: 6px solid rgba(50, 50, 50, 0.5) ;
                margin: auto;              
                z-index: 10;
            }
            #loadicon {
                position:relative;
                left:420px;
                top:210px;
                font-size: 3em;
                color: white;
            }
        </style>

        <dmw-sensor id='primary' sensorkey="primary" sensorvalue="{{sensorvalue}}" sensorhistory="{{history}}"></dmw-sensor>
        <shadow></shadow>
        <div id='bool'>
          <span id='boolicon' class='glyphicon glyphicon-question-sign' aria-label='{{booltext}}'>{{booltext}}</span>
        </div>
        
        <div id="icongraph" on-click="{{displayGraph}}">
            <a id="icongraphlink" href="#"><i class="fa fa-area-chart"></i></a>
        </div>
        <div id="graph" on-dblclick="{{hideGraph}}"><i id="loadicon" class="fa fa-spinner fa-pulse"></i></div>

    </template>

    <script>
        // ------------------------------------------------------------------------------------
        Polymer('dmw-highcharts-sensorBoolChart', {
            ready: function() {
                this.super();
 
                Highcharts.setOptions({
                    global: { 
                        useUTC: false 
                    }  
                });
                
                this.periode = i18n.t("highcharts:Day") ;
                initialZIndex = this.style.zIndex;      // z-index for the zoom mode
                
            },

            // ------------------------------------------------------------------------------------
            optionsUpdated: function() {
                if (this.options['hideLabels'] == true ) {         
                    this.$.labelprimary.style.visibility = "hidden";
                    this.$.labelsecondary.style.visibility = "hidden";
                }
                else {
                    this.$.labelprimary.style.visibility = "visible";
                    this.$.labelsecondary.style.visibility = "visible";
                }
                this.color = this.options['color'] ;
                //console.error("theme: " + this.options['theme']) ;
            },
            
            // ------------------------------------------------------------------------------------
            sensorsUpdated: function() {
                if (this.$.primary.isSet) {
                    this.labelprimary = this.$.primary.device['name'];
                    this.labelsecondary = this.$.primary.name;
                }
            },
            
            // ------------------------------------------------------------------------------------
            sensorvalueChanged: function(oldValue, newValue) {
                newValue = newValue.stored_value;
                this.booltext = i18n.t("domoweb:bool." + newValue, { context: this.$.primary.datatype_id });
                this.$.boolicon.className = '';
                if (newValue == 1) {
                    //this.$.boolicon.className = 'glyphicon glyphicon-ok';
                    this.$.bool.classList.add('true');
                    this.$.bool.classList.remove('false');
                } else if (newValue == 0) {
                    //this.$.boolicon.className = 'glyphicon glyphicon-remove';
                    this.$.bool.classList.add('false');
                    this.$.bool.classList.remove('true');
                }
            },

            // ------------------------------------------------------------------------------------
            historyChanged: function(oldValue, newValue) { 
                //console.error("### historyChanged: " + newValue);
                this.data = [] ;
                for (i = 0; i < newValue.length; i++) {
                    var value = [] ;
                    value[0] = newValue[i].timestamp * 1000 ;
                    if (this.$.primary.datatype_id !=  "DT_OpenClose")  value[1] = newValue[i].value_num ;
                        else value[1] = newValue[i].value_num == 1 ? 0 : 1 ;
                    this.data.push(value)
                }
                //console.error("###  Data: " + this.data) ;
                
                var self = this;                                // Important for rangeSelector buttons event !
                var dataObject = {
                    rangeSelector: {
                        buttonTheme: {
                            width: 70
                        },
                        buttons: [{
                            type: '',
                            count: 1,
                            text: i18n.t('highcharts:Day')
                          },{
                            type: '',
                            count: 1,
                            text: i18n.t('highcharts:Week')
                          },{
                            type: '',
                            count: 1,
                            text: i18n.t('highcharts:Month')
                          }],
                        inputEnabled: false
                    },
                    title: {
                        text: this.$.primary.device['name']
                    },
                    subtitle: {
                        /* text: '<i>(Current ' + this.periode + ')</i>' */
                        text: '<i>(' + this.periode + ')</i>'
                    },                        
                    xAxis: {
                        gridLineWidth: 1,
                        ordinal: false,
                        events: {
                            setExtremes: function(e) {
                                if(typeof(e.rangeSelectorButton) !== 'undefined')
                                {
                                    console.error("Button " + e.rangeSelectorButton.text + " pressed");
                                    mychart.setTitle({text: i18n.t("highcharts:Loading data") + "..."});
                                    mychart.series[0].remove(true);
                                    self.periode = e.rangeSelectorButton.text;
                                    switch(self.periode) {
                                        case i18n.t("highcharts:Day"):
                                            var from = moment().subtract(1, "days").unix();
                                            break;
                                        case i18n.t("highcharts:Week"):
                                            var from = moment().subtract(1, "weeks").unix(); 
                                            break;
                                        case i18n.t("highcharts:Month"):
                                            var from = moment().subtract(1, "months").unix();
                                            break;
                                    } 
                                    console.error("### timestamp - 1 " + self.periode + ": " + from);
                                    self.$.primary.getLastFrom(from) ; 
                                }
                            }
                        }
                    },
                    yAxis: {
                        title: {
                            text: this.$.primary.name
                        },
                        opposite: false,
                    },
                    legend: {
                        enabled: true
                    },
                    series: [{
                        name: this.$.primary.name,
                        type: 'spline',
                        data: this.data,
                        color: this.color,
                        lineWidth: 1,
                        tooltip: {
                            valueDecimals: 0
                        },
                        dataGrouping: {
                            enabled: false
                        }
                    }],
                    chart: {
                        renderTo: this.$.graph
                    }
                }; 
                
                var mychart = new Highcharts.StockChart(dataObject);                
            },
            
            // ------------------------------------------------------------------------------------
            displayGraph: function() {
                this.$.graph.style.display = "block";
                this.style.zIndex = 5000;
                this.periode = i18n.t("highcharts:Day");
                var from = moment().subtract(1, "days").unix();
                this.$.primary.getLastFrom(from) ;
            },
            
            // ------------------------------------------------------------------------------------
            hideGraph: function() {
                this.$.graph.style.display = "none";
                this.style.zIndex = initialZIndex;
            },
        });
    </script>
</polymer-element>
